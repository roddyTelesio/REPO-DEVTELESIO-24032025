<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <actionCalls>
        <name>UnlockAgreement</name>
        <label>UnlockAgreement</label>
        <locationX>1700</locationX>
        <locationY>384</locationY>
        <actionName>CLM_UnlockAgreement</actionName>
        <actionType>apex</actionType>
        <connector>
            <targetReference>Success</targetReference>
        </connector>
        <flowTransactionModel>CurrentTransaction</flowTransactionModel>
        <inputParameters>
            <name>agreementId</name>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </inputParameters>
        <nameSegment>CLM_UnlockAgreement</nameSegment>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </actionCalls>
    <actionCalls>
        <name>UnlockRetros</name>
        <label>UnlockRetros</label>
        <locationX>1546</locationX>
        <locationY>924</locationY>
        <actionName>CLM_UnlockAgreement</actionName>
        <actionType>apex</actionType>
        <connector>
            <targetReference>CalloutDone</targetReference>
        </connector>
        <flowTransactionModel>CurrentTransaction</flowTransactionModel>
        <inputParameters>
            <name>agreementId</name>
            <value>
                <elementReference>UnlockLoop.Id</elementReference>
            </value>
        </inputParameters>
        <nameSegment>CLM_UnlockAgreement</nameSegment>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </actionCalls>
    <apiVersion>59.0</apiVersion>
    <areMetricsLoggedToDataCloud>false</areMetricsLoggedToDataCloud>
    <assignments>
        <name>AssignCurrentItem</name>
        <label>AssignCurrentItem</label>
        <locationX>270</locationX>
        <locationY>708</locationY>
        <assignmentItems>
            <assignToReference>CurrentAgreementInLoop.Id</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>LoopRelatedRecords.Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>CurrentAgreementInLoop.OwnerId</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Record.OwnerId</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>CurrentAgreementInLoop.ToUnlock__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>AgreementsToUpdateOwner</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>CurrentAgreementInLoop</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>LoopRelatedRecords</targetReference>
        </connector>
    </assignments>
    <customErrors>
        <name>Error</name>
        <label>Error</label>
        <locationX>1898</locationX>
        <locationY>600</locationY>
        <customErrorMessages>
            <errorMessage>WS error: {!UnlockAgreement.errorMsg}</errorMessage>
            <isFieldError>false</isFieldError>
        </customErrorMessages>
    </customErrors>
    <customErrors>
        <name>ErrorRetroUnlock</name>
        <label>ErrorRetroUnlock</label>
        <locationX>1634</locationX>
        <locationY>1140</locationY>
        <connector>
            <targetReference>UnlockLoop</targetReference>
        </connector>
        <customErrorMessages>
            <errorMessage>Error in retrocession Unlock.
Id : {!UnlockLoop.Id}
Error: {!UnlockRetros.errorMsg}</errorMessage>
            <isFieldError>false</isFieldError>
        </customErrorMessages>
    </customErrors>
    <decisions>
        <name>CalloutDone</name>
        <label>CalloutDone</label>
        <locationX>1546</locationX>
        <locationY>1032</locationY>
        <defaultConnector>
            <targetReference>ErrorRetroUnlock</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>IsFailedRetro</defaultConnectorLabel>
        <rules>
            <name>isSuccessFullRetro</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>UnlockRetros.isSuccess</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>UnlockLoop</targetReference>
            </connector>
            <label>isSuccessFullRetro</label>
        </rules>
    </decisions>
    <decisions>
        <name>CheckBypass</name>
        <label>CheckBypass</label>
        <locationX>611</locationX>
        <locationY>276</locationY>
        <defaultConnectorLabel>Not allowed</defaultConnectorLabel>
        <rules>
            <name>isAllowed</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Setup.AgreementSettings__c.CanChangeAgreementOwner__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>CheckOwnerChanged</targetReference>
            </connector>
            <label>isAllowed</label>
        </rules>
    </decisions>
    <decisions>
        <name>CheckChildAgreements</name>
        <label>CheckChildAgreements</label>
        <locationX>182</locationX>
        <locationY>900</locationY>
        <defaultConnectorLabel>Does not contain anything</defaultConnectorLabel>
        <rules>
            <name>Contains</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>AgreementsToUpdateOwner</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>UpdateAgreementsToUpdateOwner</targetReference>
            </connector>
            <label>Contains</label>
        </rules>
    </decisions>
    <decisions>
        <name>CheckOwnerChanged</name>
        <label>CheckOwnerChanged</label>
        <locationX>380</locationX>
        <locationY>384</locationY>
        <defaultConnectorLabel>OwnerNotChanged</defaultConnectorLabel>
        <rules>
            <name>Owner_Changed</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.OwnerId</leftValueReference>
                <operator>IsChanged</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>GetRelatedAgreements</targetReference>
            </connector>
            <label>Owner Changed</label>
        </rules>
    </decisions>
    <decisions>
        <name>HasRetros</name>
        <label>HasRetros</label>
        <locationX>1502</locationX>
        <locationY>708</locationY>
        <defaultConnectorLabel>NoRetros</defaultConnectorLabel>
        <rules>
            <name>YeshasRetro</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>RetriveRetros</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>UnlockLoop</targetReference>
            </connector>
            <label>Yes</label>
        </rules>
    </decisions>
    <decisions>
        <name>isChanged</name>
        <label>isChanged</label>
        <locationX>1931</locationX>
        <locationY>276</locationY>
        <defaultConnectorLabel>unchanged</defaultConnectorLabel>
        <rules>
            <name>Changed</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.OwnerId</leftValueReference>
                <operator>IsChanged</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>UnlockAgreement</targetReference>
            </connector>
            <label>Changed</label>
        </rules>
    </decisions>
    <decisions>
        <name>Success</name>
        <label>Success?</label>
        <locationX>1700</locationX>
        <locationY>492</locationY>
        <defaultConnector>
            <targetReference>Error</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>isSuccess</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>UnlockAgreement.isSuccess</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>RetriveRetros</targetReference>
            </connector>
            <label>isSuccess</label>
        </rules>
    </decisions>
    <environments>Default</environments>
    <interviewLabel>CLM - Agreement - Update Child Agreement Owners {!$Flow.CurrentDateTime}</interviewLabel>
    <label>CLM - Agreement - Update Child Agreement Owners</label>
    <loops>
        <name>LoopRelatedRecords</name>
        <label>LoopRelatedRecords</label>
        <locationX>182</locationX>
        <locationY>600</locationY>
        <collectionReference>GetRelatedAgreements</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>AssignCurrentItem</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>CheckChildAgreements</targetReference>
        </noMoreValuesConnector>
    </loops>
    <loops>
        <name>UnlockLoop</name>
        <label>UnlockLoop</label>
        <locationX>1370</locationX>
        <locationY>816</locationY>
        <collectionReference>RetriveRetros</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>UnlockRetros</targetReference>
        </nextValueConnector>
    </loops>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>AUTO_LAYOUT_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordLookups>
        <name>GetRelatedAgreements</name>
        <label>GetRelatedAgreements</label>
        <locationX>182</locationX>
        <locationY>492</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>LoopRelatedRecords</targetReference>
        </connector>
        <filterLogic>or</filterLogic>
        <filters>
            <field>Apttus__Parent_Agreement__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </filters>
        <filters>
            <field>Program__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.Program__c</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>false</getFirstRecordOnly>
        <object>Apttus__APTS_Agreement__c</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>RetriveRetros</name>
        <label>RetriveRetros</label>
        <locationX>1502</locationX>
        <locationY>600</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>HasRetros</targetReference>
        </connector>
        <filterLogic>or</filterLogic>
        <filters>
            <field>Apttus__Parent_Agreement__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </filters>
        <filters>
            <field>Program__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.Program__c</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>false</getFirstRecordOnly>
        <object>Apttus__APTS_Agreement__c</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordUpdates>
        <name>Unlock_Agreement</name>
        <label>Unlock Agreement</label>
        <locationX>50</locationX>
        <locationY>1116</locationY>
        <inputAssignments>
            <field>ToUnlock__c</field>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </inputAssignments>
        <inputReference>$Record</inputReference>
    </recordUpdates>
    <recordUpdates>
        <name>UpdateAgreementsToUpdateOwner</name>
        <label>UpdateAgreementsToUpdateOwner</label>
        <locationX>50</locationX>
        <locationY>1008</locationY>
        <connector>
            <targetReference>Unlock_Agreement</targetReference>
        </connector>
        <inputReference>AgreementsToUpdateOwner</inputReference>
    </recordUpdates>
    <start>
        <locationX>1145</locationX>
        <locationY>0</locationY>
        <connector>
            <targetReference>CheckBypass</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>OwnerId</field>
            <operator>IsChanged</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <object>Apttus__APTS_Agreement__c</object>
        <recordTriggerType>Update</recordTriggerType>
        <scheduledPaths>
            <connector>
                <targetReference>isChanged</targetReference>
            </connector>
            <pathType>AsyncAfterCommit</pathType>
        </scheduledPaths>
        <triggerType>RecordAfterSave</triggerType>
    </start>
    <status>Active</status>
    <variables>
        <name>AgreementsToUpdateOwner</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Apttus__APTS_Agreement__c</objectType>
    </variables>
    <variables>
        <name>CurrentAgreementInLoop</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Apttus__APTS_Agreement__c</objectType>
    </variables>
</Flow>
